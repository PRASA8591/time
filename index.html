<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monthly Working Hours Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Segoe UI;background:#eef3f7;margin:20px}
h2{text-align:center;color:#003c5f}
table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,.1)}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#005f73;color:#fff}
.offRow{background:#ffdede}
.btn{padding:10px 18px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin:5px}
.saveBtn{background:#0277bd;color:#fff}
.loadBtn{background:#388e3c;color:#fff}
.excelBtn{background:#f9a825}
#popup{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center}
#popup div{background:#fff;padding:25px;border-radius:10px;text-align:center}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyApOmFTkgRk-Jo5DWzd2dKFWs32ZwqaMOg",
  authDomain: "budget-c1d78.firebaseapp.com",
  projectId: "budget-c1d78"
});
const db = firebase.firestore();
</script>
</head>

<body>

<h2>Monthly Working Hours Tracker</h2>

<label><b>Select Month:</b></label>
<select id="month"></select>

<br><br>

<button class="btn saveBtn" onclick="saveData()">SAVE</button>
<button class="btn loadBtn" onclick="loadData()">LOAD</button>
<button class="btn excelBtn" onclick="downloadExcel()">DOWNLOAD EXCEL</button>

<br><br>

<table>
<thead>
<tr>
<th>OFF</th><th>Day</th><th>Start</th><th>End</th><th>Total</th>
</tr>
</thead>
<tbody id="body"></tbody>
<tfoot>
<tr><td colspan="4"><b>Monthly Total</b></td><td id="monthlyTotal">00:00</td></tr>
</tfoot>
</table>

<div id="popup">
  <div>
    <h3>Saved Successfully ✔</h3>
    <button onclick="popup.style.display='none'">OK</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const body=document.getElementById("body");
const monthSel=document.getElementById("month");

/* Build Month List */
(()=>{
  const y=new Date().getFullYear();
  for(let yr=y-1;yr<=y+1;yr++){
    for(let m=1;m<=12;m++){
      const v=`${yr}-${String(m).padStart(2,"0")}`;
      const o=document.createElement("option");
      o.value=v;o.textContent=v;
      monthSel.appendChild(o);
    }
  }
  monthSel.value=`${y}-${String(new Date().getMonth()+1).padStart(2,"0")}`;
  buildRows();
})();
monthSel.onchange=buildRows;

/* Build Table */
function buildRows(){
  body.innerHTML="";
  const [y,m]=monthSel.value.split("-");
  const days=new Date(y,m,0).getDate();

  for(let d=1;d<=days;d++){
    body.innerHTML+=`
<tr>
<td><input type="checkbox" class="off"></td>
<td>${d}</td>
<td><input type="time" class="st"></td>
<td><input type="time" class="et"></td>
<td class="tot">00:00</td>
</tr>`;
  }
  document.querySelectorAll("input").forEach(i=>i.onchange=calc);
}

/* Calculate */
function calc(){
  let sum=0;
  [...body.rows].forEach(r=>{
    if(r.querySelector(".off").checked){
      r.classList.add("offRow");
      r.querySelector(".tot").innerText="OFF";
      return;
    }
    r.classList.remove("offRow");
    const st=r.querySelector(".st").value;
    const et=r.querySelector(".et").value;
    if(st&&et){
      let s=new Date(`2000-01-01 ${st}`);
      let e=new Date(`2000-01-01 ${et}`);
      let d=(e-s)/60000;if(d<0)d+=1440;
      sum+=d;
      r.querySelector(".tot").innerText=
        String(Math.floor(d/60)).padStart(2,"0")+":"+String(d%60).padStart(2,"0");
    }
  });
  monthlyTotal.innerText=
    String(Math.floor(sum/60)).padStart(2,"0")+":"+String(sum%60).padStart(2,"0");
}

/* Save */
async function saveData(){
  try{
    const records=[...body.rows].map(r=>({
      off:r.querySelector(".off").checked,
      start:r.querySelector(".st").value,
      end:r.querySelector(".et").value,
      total:r.querySelector(".tot").innerText
    }));
    await db.collection("workHours").doc(monthSel.value).set({
      month:monthSel.value,
      records,
      total:monthlyTotal.innerText,
      savedAt:new Date()
    });
    popup.style.display="flex";
  }catch(e){
    alert("SAVE FAILED ❌\n"+e.message);
    console.error(e);
  }
}

/* Load */
async function loadData(){
  const snap=await db.collection("workHours").doc(monthSel.value).get();
  if(!snap.exists) return alert("No saved data");
  buildRows();
  snap.data().records.forEach((r,i)=>{
    const row=body.rows[i];
    row.querySelector(".off").checked=r.off;
    row.querySelector(".st").value=r.start;
    row.querySelector(".et").value=r.end;
  });
  calc();
}

/* Excel */
function downloadExcel(){
  const a=[["Day","Start","End","Total"]];
  [...body.rows].forEach((r,i)=>{
    a.push([i+1,r.querySelector(".st").value,r.querySelector(".et").value,r.querySelector(".tot").innerText]);
  });
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(a),"Hours");
  XLSX.writeFile(wb,"WorkingHours.xlsx");
}
</script>

</body>
</html>
